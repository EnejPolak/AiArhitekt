// Test script for Replicate Render API with floorplan
const fs = require("fs");
const path = require("path");

// Read .env.local
const envContent = fs.readFileSync(".env.local", "utf-8");
const replicateKeyMatch = envContent.match(/REPLICATE_API_TOKEN=(.+)/);
const replicateApiKey = replicateKeyMatch ? replicateKeyMatch[1].trim() : null;

console.log("ðŸ”‘ Replicate API Key found:", replicateApiKey ? `${replicateApiKey.substring(0, 20)}...` : "NOT FOUND");
console.log("");

if (!replicateApiKey) {
  console.error("âŒ No REPLICATE_API_TOKEN found in .env.local");
  process.exit(1);
}

// Read floorplan image and convert to base64
const floorplanPath = path.join(__dirname, "public", "test-assets", "floorplan-test.png");

if (!fs.existsSync(floorplanPath)) {
  console.error(`âŒ Floorplan image not found at: ${floorplanPath}`);
  process.exit(1);
}

const floorplanImage = fs.readFileSync(floorplanPath);
const base64Image = floorplanImage.toString("base64");
const dataUrl = `data:image/png;base64,${base64Image}`;

console.log(`ðŸ“· Floorplan image loaded: ${floorplanPath}`);
console.log(`   Size: ${floorplanImage.length} bytes (${(floorplanImage.length / 1024).toFixed(2)} KB)`);
console.log("");

// Test the Replicate Render API with floorplan mode
async function testFloorplanRender() {
  console.log("ðŸ§ª Testing Replicate Render API with floorplan mode...");
  console.log("ðŸ“¤ Sending request with questionnaire data:");
  console.log("   - Mode: floorplan");
  console.log("   - Interior Style: modern");
  console.log("   - Material Grade: premium");
  console.log("   - Furniture Style: minimalist");
  console.log("   - Render Angle: eye-level");
  console.log("");

  try {
    const response = await fetch("http://localhost:3000/api/replicate/render", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        image: dataUrl,
        mode: "floorplan",
        // Questionnaire-based render parameters
        interiorStyle: "modern",
        materialGrade: "premium",
        furnitureStyle: "minimalist",
        renderAngle: "eye-level",
        projectType: "renovation",
      }),
    });

    const data = await response.json();

    if (!response.ok) {
      console.error("âŒ ERROR:", data.error || "Unknown error");
      console.error("Status:", response.status);
      if (data.required_fields) {
        console.error("Required fields:", data.required_fields);
      }
      return;
    }

    console.log("âœ… SUCCESS!");
    console.log("");
    console.log("ðŸ“ Response Details:");
    console.log("â•".repeat(80));
    console.log("ðŸŽ¨ Generated Image URL:");
    console.log("   " + data.imageUrl);
    console.log("");
    console.log("ðŸ“‹ Configuration:");
    console.log("   Interior Style:", data.interiorStyle);
    console.log("   Mode:", data.mode);
    console.log("   Model:", data.model);
    console.log("");
    console.log("ðŸ’¬ Prompt Used:");
    console.log("   " + data.prompt);
    console.log("");
    console.log("ðŸ”— To view the image, copy this URL and open in your browser:");
    console.log("   " + data.imageUrl);
    console.log("");
    console.log("ðŸ“Š Image Details:");
    console.log("   Format: PNG (generated by Replicate)");
    console.log("   Quality: 4K render");
    console.log("   Type: Floorplan render with ControlNet");
    console.log("â•".repeat(80));
  } catch (error) {
    console.error("âŒ ERROR:", error.message);
    console.error("Full error:", error);
  }
}

// Check if server is running
console.log("âš ï¸  Make sure your Next.js dev server is running (npm run dev)");
console.log("");
setTimeout(() => {
  testFloorplanRender();
}, 2000);
